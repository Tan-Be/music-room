# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Retry –ª–æ–≥–∏–∫–∏ –¥–ª—è Supabase

## ‚úÖ –°—Ç–∞—Ç—É—Å: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

Retry –ª–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å Supabase.

## üì¶ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (`src/lib/retry.ts`)

–¢—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å retry:

#### `retryWithBackoff<T>`
–ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å exponential backoff –∏ jitter.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `maxRetries` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 3)
- `baseDelay` - –±–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –º—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1000)
- `maxDelay` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –º—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10000)
- `exponentialBackoff` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: true)
- `shouldRetry` - –∫–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –Ω—É–∂–µ–Ω –ª–∏ retry
- `onRetry` - callback –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–µ

**–ü—Ä–∏–º–µ—Ä:**
```typescript
const data = await retryWithBackoff(async () => {
  const { data, error } = await supabase.from('users').select('*')
  if (error) throw error
  return data
})
```

#### `retrySupabaseQuery<T>`
–û–±—ë—Ä—Ç–∫–∞ –¥–ª—è SELECT –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç toast –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ retry
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null` –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ –≤–º–µ—Å—Ç–æ –≤—ã–±—Ä–æ—Å–∞ –æ—à–∏–±–∫–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏

**–ü—Ä–∏–º–µ—Ä:**
```typescript
const room = await retrySupabaseQuery(async () => {
  const { data, error } = await supabase
    .from('rooms')
    .select('*')
    .eq('id', roomId)
    .single()
  if (error) throw error
  return data
})
```

#### `retryMutation`
–û–±—ë—Ä—Ç–∫–∞ –¥–ª—è INSERT/UPDATE/DELETE —Å –º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ø—ã—Ç–æ–∫.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –¢–æ–ª—å–∫–æ 2 retry –ø–æ–ø—ã—Ç–∫–∏ (–≤–º–µ—Å—Ç–æ 3)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `boolean` –≤–º–µ—Å—Ç–æ –¥–∞–Ω–Ω—ã—Ö
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –º—É—Ç–∞—Ü–∏–π

**–ü—Ä–∏–º–µ—Ä:**
```typescript
const success = await retryMutation(async () => {
  const { error } = await supabase
    .from('tracks')
    .insert([track])
  if (error) throw error
})
```

### 2. –£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ shouldRetry

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω retry:

**Retry –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è:**
- ‚úÖ –°–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ (network, timeout, fetch)
- ‚úÖ 5xx –æ—à–∏–±–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º

**Retry –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è:**
- ‚ùå PGRST116 (Not found)
- ‚ùå 23505 (Unique violation)
- ‚ùå 23503 (Foreign key violation)
- ‚ùå 42501 (Insufficient privilege)
- ‚ùå auth/invalid-credentials
- ‚ùå auth/user-not-found

### 3. Exponential Backoff —Å Jitter

–ó–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏:
- –ü–æ–ø—ã—Ç–∫–∞ 1: ~1000ms (1s + jitter)
- –ü–æ–ø—ã—Ç–∫–∞ 2: ~2000ms (2s + jitter)
- –ü–æ–ø—ã—Ç–∫–∞ 3: ~4000ms (4s + jitter)

Jitter (—Å–ª—É—á–∞–π–Ω–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è 30%) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "thundering herd" –ø—Ä–æ–±–ª–µ–º—É.

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç

### –§–∞–π–ª—ã —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π retry –ª–æ–≥–∏–∫–æ–π:

#### 1. `src/lib/auth.ts`
- ‚úÖ `getUserProfile()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `retrySupabaseQuery`
- ‚úÖ `updateUserProfile()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `retryMutation`

#### 2. `src/lib/chat-realtime.ts`
- ‚úÖ `loadRecentMessages()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `retrySupabaseQuery`
- ‚úÖ `getMessageWithUserInfo()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `retrySupabaseQuery`
- ‚úÖ `sendMessage()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `retryMutation`

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏: 93.33%

–í—Å–µ 13 —Ç–µ—Å—Ç–æ–≤ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç:

```bash
npm test -- src/lib/retry.test.ts
```

**–¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:**
- ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏
- ‚úÖ Retry –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –¥–ª—è PGRST116
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
- ‚úÖ Exponential backoff
- ‚úÖ Callback onRetry
- ‚úÖ –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è shouldRetry
- ‚úÖ Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç null –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
- ‚úÖ –ú–µ–Ω—å—à–µ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –º—É—Ç–∞—Ü–∏–π

## üìö –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–§–∞–π–ª `src/lib/retry-example.ts` —Å–æ–¥–µ—Ä–∂–∏—Ç 10 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤:

1. –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ retryWithBackoff
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ retrySupabaseQuery (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ retryMutation –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
4. –ö–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ retry
5. –ö–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ shouldRetry
6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å retry
7. –£–¥–∞–ª–µ–Ω–∏–µ —Å retry
8. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å retry
9. Retry —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
10. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ —É—Ç–∏–ª–∏—Ç–∞–º–∏ (–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ)

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤
2. **UX** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - exponential backoff —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –Ω–µ retry –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
5. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è SELECT –∑–∞–ø—Ä–æ—Å–æ–≤:
```typescript
const data = await retrySupabaseQuery(async () => {
  const { data, error } = await supabase.from('table').select('*')
  if (error) throw error
  return data
})
```

### –î–ª—è INSERT/UPDATE/DELETE:
```typescript
const success = await retryMutation(async () => {
  const { error } = await supabase.from('table').insert([item])
  if (error) throw error
})
```

### –î–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –ª–æ–≥–∏–∫–∏:
```typescript
const data = await retryWithBackoff(
  async () => {
    // –≤–∞—à –∫–æ–¥
  },
  {
    maxRetries: 5,
    baseDelay: 500,
    shouldRetry: (error) => {
      // –≤–∞—à–∞ –ª–æ–≥–∏–∫–∞
    }
  }
)
```

## üìà –ú–µ—Ç—Ä–∏–∫–∏

- **–ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞:** 93.33%
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤:** 13
- **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:** 2 (auth.ts, chat-realtime.ts)
- **–ü—Ä–∏–º–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** 10

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ú–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å retry –ª–æ–≥–∏–∫—É –≤:
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å –ø—Ä—è–º—ã–º–∏ Supabase –∑–∞–ø—Ä–æ—Å–∞–º–∏
- API routes
- Server actions
- Realtime subscriptions (—Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é)

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 27 –Ω–æ—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
