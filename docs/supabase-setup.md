# Настройка Supabase

## Создание проекта

1. Перейдите на [supabase.io](https://supabase.io) и создайте аккаунт
2. Создайте новый проект с именем "Music Room"
3. Выберите регион ближайший к вашим пользователям
4. Установите пароль для базы данных

## Конфигурация переменных окружения

После создания проекта вы получите:

- Project URL (находится в настройках проекта в разделе "General")
- Anon Key (находится в настройках проекта в разделе "General")
- Service Role Key (находится в настройках проекта в разделе "General")

### Где найти эти значения:

1. Перейдите в панель управления Supabase
2. Выберите ваш проект "Music Room"
3. В левом меню выберите "Settings" (настройки)
4. Выберите "API" в разделе настроек
5. Скопируйте следующие значения:
   - Project URL - это ваш URL для подключения к Supabase (должен начинаться с https://)
   - anon public - это ваш анонимный ключ
   - service_role secret - это ваш сервисный ключ

Добавьте эти значения в файл `.env.local`:

```
NEXT_PUBLIC_SUPABASE_URL=ваш_урл_проекта_supabase
NEXT_PUBLIC_SUPABASE_ANON_KEY=ваш_анонимный_ключ_supabase
SUPABASE_SERVICE_ROLE_KEY=ваш_сервисный_ключ_supabase
SPOTIFY_CLIENT_ID=ваш_client_id_spotify
SPOTIFY_CLIENT_SECRET=ваш_client_secret_spotify
```

**Важно:**

- Замените placeholder значения на реальные данные из вашего Supabase проекта
- URL должен начинаться с `https://`
- Не используйте кавычки вокруг значений в .env файле
- После изменения .env файла перезапустите сервер разработки

### Проверка конфигурации

Вы можете проверить правильность конфигурации переменных окружения с помощью скрипта:

```bash
pnpm run check-env
```

## Настройка аутентификации

1. Перейдите в раздел Authentication в панели управления Supabase
2. Включите Email authentication
3. Настройте провайдеров OAuth:
   - Для Spotify:
     1. Создайте приложение в Spotify Developer Dashboard
     2. Добавьте URL перенаправления: `http://localhost:3000/auth/callback`
     3. Скопируйте Client ID и Client Secret
     4. Добавьте их в переменные окружения
     5. В разделе Authentication Providers в Supabase включите Spotify и добавьте Client ID и Client Secret
4. Настройте параметры аутентификации:
   - Установите минимальную длину пароля (рекомендуется 8 символов)
   - Включите подтверждение email
   - Настройте автоматическое обновление сессий

## Создание таблиц базы данных

1. Перейдите в раздел SQL Editor в панели управления Supabase
2. Выполните SQL скрипт из файла `src/lib/schema.sql`
3. Проверьте, что все таблицы созданы успешно

## Настройка политик безопасности (RLS)

1. Включите RLS для каждой таблицы
2. Выполните SQL скрипт из файла `src/lib/rls_policies.sql` для настройки политик доступа
3. Настройте политики доступа в соответствии с ролями пользователей:
   - Профили: Пользователи могут читать и обновлять только свои профили
   - Комнаты: Публичные комнаты доступны всем, приватные - только участникам
   - Участники: Пользователи могут присоединяться и покидать комнаты
   - Треки: Пользователи могут добавлять, обновлять и удалять только свои треки
   - Очередь: Участники могут добавлять треки, модераторы могут управлять очередью
   - Чат: Участники могут читать и отправлять сообщения, модераторы могут удалять сообщения
4. Протестируйте доступ к данным

## Настройка Realtime

1. Включите Realtime для таблицы `chat_messages`
2. Настройте подписки в клиентском коде
3. Протестируйте функциональность в реальном времени

## Тестирование аутентификации

1. Запустите приложение локально
2. Перейдите на страницу регистрации
3. Создайте тестового пользователя
4. Проверьте вход/выход
5. Убедитесь, что защищенные маршруты работают корректно
6. Протестируйте вход через Spotify OAuth
